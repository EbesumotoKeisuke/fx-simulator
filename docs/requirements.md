# 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
FX Trade Simulator（FXトレードシミュレーター）

### 1.2 概要説明
実際のFX市場に近い環境でトレードの練習ができるシミュレーションツール。過去の為替データを使用してリアルな相場環境を再現し、仮想資金でトレードを行うことで、リスクなくトレードスキルを磨くことができる。

### 1.3 目的・背景
- **目的**: ユーザーのFXトレードスキル向上を支援する
- **背景**: 実際の資金を使わずにトレード経験を積むことで、リスク管理や相場分析のスキルを安全に習得したい

## 2. ユーザー定義

### 2.1 想定ユーザー
- 個人利用（開発者本人のみ）
- FXトレードの練習・スキル向上を目指す個人トレーダー

### 2.2 ユーザーの課題・ニーズ
| 課題 | ニーズ |
|------|--------|
| 実資金でのトレードはリスクが高い | リスクなしで練習したい |
| 過去の相場で自分の判断を検証したい | 過去データでのバックテスト機能 |
| トレードの記録・分析が手間 | 自動で履歴を記録し分析したい |
| 感情的なトレードを減らしたい | 客観的なパフォーマンス指標の確認 |

## 3. 機能要件

### 3.1 必須機能（MVP）
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| F-001 | マルチタイムフレームチャート表示 | 日足・1時間足・10分足のローソク足チャートを同時表示。各時間足の最新時刻は同期して一致すること。各タイムフレームは境界を跨いだ時のみ更新し、高速再生時でも点滅しない | 高 |
| F-002 | 過去データ再生 | 過去の為替データを時系列で再生（早送り・一時停止可能）。一時停止ボタンを押した瞬間にチャート更新が即座に停止すること | 高 |
| F-003 | 注文機能 | 成行注文（買い/売り）の発注 | 高 |
| F-004 | ポジション管理 | 保有中のポジション一覧表示・決済。ロットサイズ、購入価格（エントリー価格）を表示 | 高 |
| F-005 | 損益計算 | リアルタイムの含み損益・確定損益の計算・表示 | 高 |
| F-006 | 仮想資金管理 | 初期資金の設定、残高管理 | 高 |
| F-007 | トレード履歴 | 過去のトレード履歴の記録・一覧表示 | 高 |
| F-008 | 為替データ読込 | ローカルフォルダに格納されたCSVファイル（日足・1時間足・10分足）から為替データを読み込む | 高 |

### 3.2 追加機能（あれば嬉しい）
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| F-101 | 指値・逆指値注文 | 価格指定での予約注文（両方サポート、複数同時注文可能、キャンセル・変更可能） | 中 |
| F-102 | 損切り・利確設定 | ポジションごとのSL/TP設定（新規注文時・既存ポジション両方、価格・pips両対応、チャート表示） | 中 |
| F-103 | 複数通貨ペア対応 | USD/JPY以外の通貨ペアにも対応 | 中 |
| F-104 | テクニカル指標 | 移動平均線、RSI、MACD等の表示 | 中 |
| F-105 | パフォーマンス分析 | 勝率、プロフィットファクター、最大ドローダウン等の統計（専用分析画面 + メイン画面の簡易表示、グラフ表示） | 中 |
| F-106 | トレードメモ | 各トレードにメモ・振り返りを記録 | 低 |
| F-107 | 再生速度調整 | チャート再生速度の細かい調整（0.5x〜10x） | 低 |
| F-108 | シミュレーション開始日時指定 | 任意の日時からシミュレーションを開始できる | 中 |
| F-109 | シミュレーション終了・CSV出力 | 終了ボタンでシミュレーションを終了し、トレード履歴をCSVファイルとして出力。終了時に保有中の全ポジションを自動決済し、最終損益を確定する | 中 |
| F-110 | 統合画面レイアウト | 日足・1時間足・10分足チャートとトレード操作パネル（注文・ポジション管理）を1画面に同時表示 | 高 |
| F-111 | 外部データソース取込 | 外部の無料データソースから過去の為替データを取得し、ローカルCSVファイルに追記・更新する | 中 |

## 4. 非機能要件

### 4.1 性能要件
- チャートの描画はスムーズに動作すること（60fps目標）
- 過去データの読み込みは5秒以内
- 注文処理は即座に反映されること

### 4.2 セキュリティ要件
- 個人利用のため、認証機能は不要
- ローカル環境での動作を前提

### 4.3 可用性要件
- ローカル環境で安定して動作すること
- データの永続化（ブラウザを閉じてもトレード履歴が保持される）

### 4.4 保守性要件
- コードは可読性を重視
- 機能追加が容易な設計

## 5. 制約条件

### 5.1 技術的制約
- バックエンド: Python（FastAPI）
- フロントエンド: React（TypeScript）
- データベース: PostgreSQL
- 開発環境: Docker
- 為替データ:
  - ユーザーが用意したCSVファイル（日足・1時間足・10分足）をローカルフォルダに格納
  - 不足データは外部の無料データソース（例: Yahoo Finance API等）から取得可能

### 5.2 スケジュール制約
- 特になし（個人プロジェクト）

### 5.3 その他制約
- 実際の取引所との接続は行わない（シミュレーションのみ）
- リアルタイムデータ配信は行わない（過去データの再生のみ）

## 6. 用語定義
| 用語 | 説明 |
|------|------|
| ポジション | 保有中の通貨の持ち高（買いまたは売りの状態） |
| 成行注文 | 現在の市場価格で即座に約定する注文 |
| 指値注文 | 指定した価格に達したら約定する予約注文 |
| 逆指値注文 | 指定した価格に達したら成行で約定する予約注文 |
| SL（ストップロス） | 損切りライン。損失を限定するための決済価格 |
| TP（テイクプロフィット） | 利確ライン。利益を確定するための決済価格 |
| pips | 為替レートの最小変動単位（USD/JPYの場合0.01円） |
| ロット | 取引数量の単位（1ロット = 10万通貨が一般的） |
| スプレッド | 買値と売値の差額 |
| ドローダウン | 資産のピークからの下落幅 |
| プロフィットファクター | 総利益 ÷ 総損失 |

## 7. 前提条件・依存関係
- ユーザーが為替データCSVファイル（日足・1時間足・10分足）を用意し、所定のフォルダに格納すること
- CSVファイルのフォーマット: 日時, 始値, 高値, 安値, 終値, 出来高（OHLCV形式）
- Docker環境が利用可能であること
- モダンブラウザ（Chrome, Firefox, Edge等）で動作
- 外部データソース利用時はインターネット接続が必要

## 8. 追加機能の詳細仕様

### 8.1 F-101: 指値・逆指値注文

#### 概要
現在の成行注文に加えて、指値注文（Limit Order）と逆指値注文（Stop Order）の機能を追加する。トレーダーが特定の価格に達したときに自動的に注文を執行できるようにする。

#### 機能詳細
- **対応注文タイプ**:
  - 指値注文（Limit Order）: 指定価格以下で買い、または指定価格以上で売り
  - 逆指値注文（Stop Order）: 指定価格以上で買い、または指定価格以下で売り
- **複数注文**: 同時に複数の予約注文を保持可能
- **注文管理**:
  - 注文のキャンセル: 未約定の注文を削除可能
  - 注文の変更: 価格やロットサイズの変更可能
- **注文の有効期限**: 実装しない（手動キャンセルまで有効）
- **シミュレーション状態との関係**:
  - 一時停止時: 未約定注文はそのまま保持
  - 終了時: 未約定注文は全てキャンセル
- **約定ロジック**:
  - 10分足のローソク足OHLC（始値・高値・安値・終値）のいずれかが注文価格に達したときに約定
  - 約定価格は設定したトリガー価格
  - 約定後は通常のポジションとして管理
- **通知**: 約定時の通知機能は実装しない

#### UI設計
- **注文入力パネル**:
  - 場所: コントロールバーの下部または専用エリア
  - 入力項目: 注文タイプ（指値/逆指値）、売買方向（買/売）、ロットサイズ、トリガー価格
  - 操作: 注文ボタンで予約注文を作成
- **未約定注文一覧**:
  - 場所: ポジション一覧と口座情報の間
  - 表示項目: 注文タイプ、売買方向、ロットサイズ、トリガー価格、作成日時
  - 操作: 各注文に対してキャンセルボタン、変更ボタン
- **チャート表示**:
  - 10分足チャートに未約定注文の価格ラインを表示（オプション）
  - 指値注文: 青色ライン
  - 逆指値注文: オレンジ色ライン

---

### 8.2 F-102: 損切り・利確設定（SL/TP）

#### 概要
ポジションごとに損切り（Stop Loss）と利確（Take Profit）を設定できる機能。リスク管理と利益確定を自動化する。

#### 機能詳細
- **設定タイミング**:
  - 新規注文時: 成行注文・予約注文の作成時に同時設定
  - 既存ポジション: 保有中のポジションに後から追加・変更
- **設定方法**:
  - 価格指定: 具体的な価格を指定（例: 145.50円）
  - pips指定: エントリー価格からのpips数で指定（例: -20pips、+30pips）
  - 両方の指定方法をサポート
- **チャート表示**:
  - 10分足チャートにSL/TPのラインを表示
  - SLライン: 赤色の破線
  - TPライン: 緑色の破線
  - ポジションごとに対応するラインを表示
- **判定タイミング**:
  - 10分足のローソク足OHLC（始値・高値・安値・終値）のいずれかが基準を満たしたとき
  - チェックタイミング: シミュレーション時刻が更新されるたび
- **同時発動時の処理**:
  - 同一ローソク足でSLとTPの両方が満たされた場合、ユーザーに確認を求める
  - モーダル表示: 「損切りと利確の両方が達成されました。どちらを優先しますか？」
  - ユーザー選択: 損切り優先 / 利確優先
- **トレーリングストップ**: 実装しない（次フェーズで検討）

#### UI設計
- **注文入力パネル**:
  - SL設定: チェックボックス + 価格入力 / pips入力
  - TP設定: チェックボックス + 価格入力 / pips入力
  - 切替: 価格/pipsの切替ボタン
- **ポジション一覧**:
  - 表示項目追加: SL価格、TP価格
  - 操作: 各ポジションに「SL/TP設定」ボタン
- **SL/TP設定モーダル**:
  - 既存ポジションに対してSL/TPを設定・変更
  - 入力項目: SL（価格 or pips）、TP（価格 or pips）
  - プレビュー: 現在価格とSL/TPの位置関係を表示
- **同時発動確認モーダル**:
  - メッセージ: 同一ローソク足でSLとTPの両方が達成
  - ボタン: 「損切りを実行」「利確を実行」

---

### 8.3 F-105: パフォーマンス分析

#### 概要
シミュレーション結果を多角的に分析し、トレード成績を可視化する機能。トレーダーが自身のパフォーマンスを客観的に評価できるようにする。

#### 機能詳細
- **分析指標**:
  - **基本指標**:
    - 勝率（Win Rate）: 勝ちトレード数 / 総トレード数
    - 総損益（Total P&L）: 確定損益の合計
    - 総利益（Gross Profit）: 勝ちトレードの損益合計
    - 総損失（Gross Loss）: 負けトレードの損益合計
    - トレード回数（Total Trades）: 決済済みトレードの総数
  - **リスク・リターン指標**:
    - プロフィットファクター（Profit Factor）: 総利益 / 総損失
    - 平均利益（Average Win）: 総利益 / 勝ちトレード数
    - 平均損失（Average Loss）: 総損失 / 負けトレード数
    - リスクリワード比（Risk/Reward Ratio）: 平均利益 / 平均損失
    - 最大利益（Max Win）: 単一トレードの最大利益
    - 最大損失（Max Loss）: 単一トレードの最大損失
  - **ドローダウン指標**:
    - 最大ドローダウン（Max Drawdown）: 資産ピークからの最大下落額（円）
    - 最大ドローダウン率（Max Drawdown %）: 資産ピークからの最大下落率（%）
    - 最大ドローダウン期間（Max Drawdown Duration）: 最大ドローダウンの発生から回復までの期間
  - **連続性指標**:
    - 最大連勝数（Max Consecutive Wins）: 連続して勝ちトレードが続いた最大数
    - 最大連敗数（Max Consecutive Losses）: 連続して負けトレードが続いた最大数
  - **期間別指標**:
    - 日別損益: 日ごとの確定損益
    - 週別損益: 週ごとの確定損益
    - 月別損益: 月ごとの確定損益
- **グラフ表示**:
  - 資産曲線（Equity Curve）: 時系列での資産推移をライングラフで表示
  - 損益分布（P&L Distribution）: トレードごとの損益を棒グラフで表示
  - ドローダウングラフ: ドローダウンの推移を表示
  - 勝ち負け分布: 勝ちトレードと負けトレードの割合を円グラフで表示
- **比較機能**: 複数シミュレーション間の比較は次フェーズで実装

#### UI設計
- **メイン画面の簡易表示**:
  - 場所: 口座情報パネルの下部または右側
  - 表示項目: 勝率、プロフィットファクター、最大ドローダウン（主要3指標のみ）
  - サイズ: コンパクトなウィジェット形式
  - 操作: クリックで詳細分析画面（SCR-005）へ遷移
- **詳細分析画面（SCR-005）**:
  - レイアウト:
    - 上部: 主要指標カード（6〜8個）
    - 中央: 資産曲線グラフ（大きく表示）
    - 中下部: その他のグラフ（2〜3個を横並び）
    - 下部: 詳細統計 + プロからの改善コメント
  - 表示切替: 期間フィルター（全期間 / 直近1週間 / 直近1ヶ月）
  - エクスポート: 分析結果をPDFまたはCSVで出力（オプション）

#### AI改善コメント機能
- **概要**: ChatGPT APIまたはMCPサーバーを活用し、プロの為替トレーダー視点での改善提案を自動生成
- **入力データ**:
  - トレード履歴（全決済済みトレードの詳細）
  - 市場データ（CSVから取得した価格・テクニカル指標）
  - パフォーマンス指標（勝率、PF、DD等）
- **出力形式**:
  - 3〜5個の具体的な改善ポイント
  - 各ポイントには理由と具体的なアドバイスを含む
  - タイムスタンプ付きで最終更新日時を表示
- **実装方式**:
  - 方式1: ChatGPT API（OpenAI API）を直接呼び出し
  - 方式2: MCPサーバー経由でLLMと通信
  - どちらの方式でも実装可能な設計とする
- **プロンプト設計**:
  - ロール: 「あなたは経験豊富なプロの為替トレーダーです」
  - タスク: 「以下のトレードデータと市場環境を分析し、具体的な改善ポイントを3〜5個提案してください」
  - 出力形式: 番号付きリスト、各項目に理由と改善案を含む

---

## 9. 実装済み機能の今後の拡張

### 9.1 F-101: 指値・逆指値注文の拡張

**現在の実装状況**:
- ✓ バックエンドAPI完全実装（注文作成、変更、キャンセル、約定チェック）
- ✓ 単体テスト完了（8/8テスト成功）
- △ フロントエンドUI（基本的な実装のみ）

**今後の拡張機能**:
- チャート上に未約定注文の価格ラインを表示
  - 指値注文: 青色ライン
  - 逆指値注文: オレンジ色ライン
  - ドラッグで価格変更可能
- ✓ 注文パネルの改善（一部実装済み）
  - ✓ 現在価格との差分（pips）をリアルタイム表示（実装済み）
  - ワンクリック注文機能（未実装・実装不要）
- 注文履歴の詳細表示
  - 約定までの経過時間
  - 約定時の市場状況（ローソク足情報）

---

### 9.2 F-102: 損切り・利確設定（SL/TP）の拡張

**現在の実装状況**:
- ✓ バックエンドAPI完全実装（設定、判定、自動決済）
- ✓ 単体テスト完了（6/6テスト成功）
- ✓ フロントエンドUI完全実装（OrderPanel、PositionPanel）

**実装済み機能の詳細**:
- **OrderPanel（成行注文時のSL/TP設定）**:
  - チェックボックスでSL/TPを個別に有効/無効化
  - 価格指定とpips指定の切り替え機能
  - 成行注文時のみ表示（指値・逆指値注文時は非表示）
- **PositionPanel（既存ポジションのSL/TP設定）**:
  - ポジション一覧にSL/TPカラムを表示（価格またはpips）
  - 各ポジションに「SL/TP」ボタンを配置
  - モーダルでSL/TPを編集（チェックボックスで個別有効化）
  - 既存のSL/TP値がある場合は自動読み込み
- **バリデーション機能**:
  - 価格指定時：エントリー価格との大小関係をチェック
    - 買い：SL < エントリー価格、TP > エントリー価格
    - 売り：SL > エントリー価格、TP < エントリー価格
  - 条件違反時はエラーメッセージを表示し保存を防止
  - pips指定時：バックエンドで自動計算されるため、フロントエンドでのバリデーションは不要
- **✓ SL/TP設定のプリセット機能（実装済み）**:
  - OrderPanel（成行注文時）とPositionPanel（編集モーダル）に実装
  - pips指定モード時に4つのプリセットボタンを表示：-10, -20, -30, -50 pips
  - バックエンドの計算ロジック：
    - 買い：SL価格 = エントリー価格 + (sl_pips × 0.01)、TP価格 = エントリー価格 + (tp_pips × 0.01)
    - 売り：SL価格 = エントリー価格 - (sl_pips × 0.01)、TP価格 = エントリー価格 - (tp_pips × 0.01)
  - SLは常に負の値を使用（買い・売りともに）
  - TPは買いは正の値、売りは負の値を使用
  - ワンクリックで一般的なSL値を素早く設定可能
  - 位置：SL入力欄の横に配置（OrderPanel）、入力欄の下に配置（PositionPanel）
- **✓ 予約注文の現在価格との差分表示（実装済み）**:
  - 指値・逆指値注文時にトリガー価格入力欄の横にpips差分を表示
  - 計算式：(トリガー価格 - 現在価格) / 0.01
  - 表示形式：(+X.X pips) または (-X.X pips)
  - リアルタイム更新：トリガー価格を変更すると即座に再計算

**今後の拡張機能**:
- チャート上にSL/TPラインを表示
  - SLライン: 赤色の破線
  - TPライン: 緑色の破線
  - ドラッグで価格変更可能
- 同時発動時の確認モーダル
  - 同一ローソク足でSLとTPが両方達成された場合の処理選択
  - ユーザー選択: 損切り優先 / 利確優先
- トレーリングストップ機能
  - 価格が有利な方向に動いたときにSLを自動調整
  - トレーリング幅の設定（pips指定）

---

### 9.3 F-105: パフォーマンス分析の拡張

**現在の実装状況**:
- ✓ バックエンドAPI実装（基本指標、資産曲線、ドローダウン）
- ✓ 単体テスト完了（5/5テスト成功）
- ✓ フロントエンドUI実装完了（AccountInfo簡易表示、AnalysisPage詳細画面）

**実装済み機能の詳細**:
- **AccountInfo（簡易パフォーマンス表示）**:
  - 場所：メイン画面の口座情報パネル下部
  - 表示項目：
    - 取引回数（勝/負）
    - 勝率（50%以上で緑色表示）
    - プロフィットファクター（1.0以上で緑色、未満で赤色）
    - 最大ドローダウン（金額と%）
    - 最大連勝/連敗
  - 取引データがある場合のみ表示（total_trades > 0）
- **AnalysisPage（詳細分析画面）**:
  - ルーティング：/analysis パス
  - ヘッダーに「分析」ボタンを追加（idle状態では無効化）
  - レイアウト構成：
    - 主要指標カード（4つ）：勝率、PF、最大DD、トータル損益
    - リスク・リターン指標セクション：平均利益/損失、RR比、最大利益/損失、DD継続期間
    - 連続記録セクション：最大連勝/連敗
    - シミュレーション期間情報：開始日時、終了日時、期間
    - 資産曲線データテーブル（最新10件表示）
    - ドローダウンデータテーブル（最新10件表示）
  - データがない場合の適切なエラー表示

**今後の拡張機能**:
- 期間別指標の実装
  - 日別/週別/月別の損益集計
  - カレンダー形式での損益表示
- 資産曲線の時間・日単位集約
  - interval パラメータ（hour, day）の実装
  - データ量削減とパフォーマンス向上
- AI改善コメント機能
  - ChatGPT APIまたはMCPサーバーとの連携
  - トレード履歴と市場データを元にした改善提案
  - プロの為替トレーダー視点でのアドバイス生成
- 詳細分析画面（SCR-005）の実装
  - 主要指標カードの表示
  - 資産曲線、損益分布、ドローダウンの複合グラフ
  - トレード履歴との連動表示
- エクスポート機能
  - 分析結果のPDF出力
  - トレード履歴のCSV出力
- 複数シミュレーション間の比較機能
  - 異なる戦略の成績を並べて比較
  - ベンチマークとの比較

---

## 10. 将来の拡張性
- リアルタイムデータとの連携（将来的に）
- 自動売買ロジックのバックテスト機能
- 複数の取引戦略のパフォーマンス比較
- モバイル対応
