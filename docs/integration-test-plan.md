# 結合テスト計画書

## 1. テスト概要

### 1.1 目的
FX Trade Simulatorの全機能が統合された状態で正しく動作することを確認する。

### 1.2 テスト範囲
- シミュレーション基本機能（開始・一時停止・再開・終了）
- マルチタイムフレームチャート表示と更新
- トレード機能（注文・ポジション管理・決済）
- データ管理機能（為替データ読込・CSV出力）
- 各種速度でのパフォーマンス

### 1.3 テスト環境
- OS: Windows
- ブラウザ: Chrome（最新版）
- バックエンド: Docker環境（FastAPI + PostgreSQL）
- フロントエンド: Docker環境（React + TypeScript）

### 1.4 前提条件
- Dockerが起動している
- docker-compose upでアプリケーションが起動している
- ローカルフォルダにCSVデータ（日足・1時間足・10分足）が格納されている
- ブラウザで http://localhost:3000 にアクセス可能

---

## 2. テストケース一覧

### 2.1 環境確認テスト

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| ENV-001 | Docker起動確認 | `docker-compose ps`を実行 | frontend, backend, dbの3コンテナがUp状態 | 高 |
| ENV-002 | フロントエンド接続 | http://localhost:3000 にアクセス | メインページが表示される | 高 |
| ENV-003 | バックエンド接続 | http://localhost:8000/docs にアクセス | FastAPI Swagger UIが表示される | 高 |
| ENV-004 | データベース接続 | バックエンドログ確認 | DB接続エラーがない | 高 |

---

### 2.2 シミュレーション基本機能テスト

#### 2.2.1 シミュレーション開始

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| SIM-001 | 初期表示 | メインページを開く | ①開始日時入力フィールド<br>②初期資金入力フィールド<br>③速度選択（1x, 5x, 10x）<br>④開始ボタンが表示される | 高 |
| SIM-002 | 開始日時指定 | ①開始日時を入力（例: 2024-01-15 09:00）<br>②初期資金を入力（例: 1000000）<br>③開始ボタンをクリック | ①シミュレーションが開始される<br>②日足・1時間足・10分足チャートが表示される<br>③現在時刻表示が開始日時になる<br>④残高が初期資金と一致 | 高 |
| SIM-003 | 速度1x開始 | 速度1xで開始 | ①チャートが1秒ごとに更新される<br>②現在時刻が1秒=10分の速度で進む | 高 |
| SIM-004 | 速度5x開始 | 速度5xで開始 | ①チャートが0.2秒ごとに更新される<br>②現在時刻が0.2秒=10分の速度で進む | 高 |
| SIM-005 | 速度10x開始 | 速度10xで開始 | ①チャートが0.1秒ごとに更新される<br>②現在時刻が0.1秒=10分の速度で進む<br>③チャートが正常に更新される（点滅なし）| 高 |

#### 2.2.2 シミュレーション制御

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| SIM-006 | 一時停止（1x） | ①速度1xで開始<br>②一時停止ボタンをクリック | ①チャート更新が停止する<br>②現在時刻が止まる<br>③再開ボタンが表示される | 高 |
| SIM-007 | 一時停止（5x） | ①速度5xで開始<br>②一時停止ボタンをクリック | ①即座にチャート更新が停止する<br>②10分足チャートも即座に停止する<br>③数秒間更新が続かない | 高 |
| SIM-008 | 一時停止（10x） | ①速度10xで開始<br>②一時停止ボタンをクリック | ①即座にチャート更新が停止する<br>②全てのチャートが即座に停止する | 高 |
| SIM-009 | 再開 | ①一時停止状態から再開ボタンをクリック | ①チャート更新が再開される<br>②現在時刻が進み始める | 高 |
| SIM-010 | 速度変更 | ①速度1xで開始<br>②速度を5xに変更 | ①チャート更新速度が5xに変わる<br>②チャートが正常に表示される | 中 |
| SIM-011 | シミュレーション終了 | ①終了ボタンをクリック<br>②確認ダイアログでOK | ①シミュレーションが停止する<br>②結果ポップアップが表示される | 高 |

---

### 2.3 チャート表示・更新テスト

#### 2.3.1 マルチタイムフレーム表示

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| CHART-001 | 3チャート同時表示 | シミュレーション開始 | ①日足チャート<br>②1時間足チャート<br>③10分足チャートが同時に表示される | 高 |
| CHART-002 | 各チャートのラベル | チャート確認 | 各チャートに「日足」「1時間足」「10分足」のラベルが表示される | 中 |
| CHART-003 | ローソク足形状 | チャート確認 | ①始値・高値・安値・終値が正しく表示される<br>②陽線は緑、陰線は赤で表示される | 高 |

#### 2.3.2 チャート更新タイミング（10x速度）

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| CHART-004 | 10分足更新 | 速度10xで10分経過を観察 | 10分足チャートが新しいローソク足を追加する | 高 |
| CHART-005 | 1時間足更新 | 速度10xで1時間経過を観察 | ①1時間足チャートが新しいローソク足を追加する<br>②60分経過時に正確に更新される | 高 |
| CHART-006 | 日足更新（24:00） | 速度10xで24:00をまたぐように実行 | ①24:00（日付変更）時に日足チャートが新しいローソク足を追加する<br>②点滅や重複がない | 高 |
| CHART-007 | 日足更新（複数日） | 速度10xで数日間実行 | ①毎日24:00に日足が更新される<br>②更新タイミングが一定 | 高 |

#### 2.3.3 チャート更新パフォーマンス

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| CHART-008 | 10分足点滅なし（10x） | 速度10xで5分以上実行 | 10分足チャートが点滅せず、スムーズに更新される | 高 |
| CHART-009 | 1時間足点滅なし（10x） | 速度10xで30分以上実行 | 1時間足チャートが点滅せず、スムーズに更新される | 高 |
| CHART-010 | 日足点滅なし（10x） | 速度10xで数日実行 | 日足チャートが点滅せず、スムーズに更新される | 高 |

---

### 2.4 トレード機能テスト

#### 2.4.1 注文機能

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| TRADE-001 | 買い注文（成行） | ①ロットサイズ0.1を入力<br>②買いボタンをクリック | ①注文が約定される<br>②ポジション一覧に表示される<br>③エントリー価格が表示される | 高 |
| TRADE-002 | 売り注文（成行） | ①ロットサイズ0.1を入力<br>②売りボタンをクリック | ①注文が約定される<br>②ポジション一覧に表示される<br>③エントリー価格が表示される | 高 |
| TRADE-003 | 複数ロット注文 | ①ロットサイズ1.0を入力<br>②買いボタンをクリック | ①1.0ロットのポジションが建つ<br>②必要証拠金が正しく計算される | 中 |
| TRADE-004 | 最小ロット注文 | ①ロットサイズ0.01を入力<br>②買いボタンをクリック | 0.01ロットのポジションが建つ | 中 |
| TRADE-005 | 無効なロットサイズ | ①ロットサイズ0を入力<br>②買いボタンをクリック | エラーメッセージが表示される | 中 |
| TRADE-006 | 残高不足 | ①初期資金10,000円で開始<br>②ロットサイズ10.0を入力<br>③買いボタンをクリック | ①エラーメッセージが表示される<br>②注文が約定されない | 中 |

#### 2.4.2 ポジション管理

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| TRADE-007 | ポジション表示 | 買い注文を1件実行 | ①ポジション一覧に1件表示される<br>②side: buy<br>③lot_size: 入力値<br>④entry_price: 約定価格<br>⑤opened_at: 約定時刻が表示される | 高 |
| TRADE-008 | 含み損益表示 | ①買いポジション保有<br>②相場が上昇 | ①unrealized_pnl（含み損益）がプラス表示<br>②current_price（現在価格）が更新される | 高 |
| TRADE-009 | 含み損失表示 | ①買いポジション保有<br>②相場が下落 | ①unrealized_pnl（含み損益）がマイナス表示<br>②赤字で表示される | 高 |
| TRADE-010 | 複数ポジション | ①買いポジション1件<br>②売りポジション1件を建てる | ①両方のポジションが一覧に表示される<br>②合計含み損益が正しく計算される | 中 |

#### 2.4.3 ポジション決済

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| TRADE-011 | 利益確定決済 | ①買いポジション保有（含み益あり）<br>②決済ボタンをクリック | ①ポジションが決済される<br>②realized_pnl（確定損益）がプラス<br>③balance（残高）が増加<br>④トレード履歴に記録される | 高 |
| TRADE-012 | 損切り決済 | ①買いポジション保有（含み損あり）<br>②決済ボタンをクリック | ①ポジションが決済される<br>②realized_pnl（確定損益）がマイナス<br>③balance（残高）が減少<br>④トレード履歴に記録される | 高 |
| TRADE-013 | 複数決済 | ①3件のポジションを建てる<br>②1件ずつ決済 | ①各ポジションが正しく決済される<br>②残高が正しく更新される<br>③トレード履歴が3件記録される | 中 |

---

### 2.5 資金・損益管理テスト

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| ACCOUNT-001 | 初期資金設定 | 初期資金1,000,000円で開始 | balance（残高）が1,000,000円と表示される | 高 |
| ACCOUNT-002 | 残高更新（利益） | ①ポジション決済で+10,000円<br>②口座情報確認 | balance（残高）が1,010,000円になる | 高 |
| ACCOUNT-003 | 残高更新（損失） | ①ポジション決済で-5,000円<br>②口座情報確認 | balance（残高）が995,000円になる | 高 |
| ACCOUNT-004 | 証拠金計算 | ①0.1ロットの買いポジション<br>②口座情報確認 | ①margin_used（使用証拠金）が表示される<br>②margin_available（余剰証拠金）が計算される | 中 |
| ACCOUNT-005 | 評価額計算 | ①ポジション保有（含み益あり）<br>②口座情報確認 | equity（評価額）= balance + unrealized_pnl | 高 |
| ACCOUNT-006 | トレード履歴記録 | ①複数回トレード<br>②トレード履歴確認 | ①全てのトレードが記録されている<br>②trade_id, side, lot_size, entry_price, exit_price, realized_pnl, opened_at, closed_atが記録されている | 高 |

---

### 2.6 シミュレーション終了・結果表示テスト

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| RESULT-001 | 結果ポップアップ表示 | ①トレード実施<br>②終了ボタンをクリック | ①結果ポップアップが表示される<br>②最終残高、総トレード数、確定損益が表示される | 高 |
| RESULT-002 | 保有ポジション自動決済 | ①ポジション2件保有<br>②終了ボタンをクリック | ①全てのポジションが自動決済される<br>②決済された損益が最終損益に反映される | 高 |
| RESULT-003 | トレード0件の結果 | ①トレードせず終了<br>②終了ボタンをクリック | ①結果ポップアップが表示される<br>②総トレード数: 0<br>③最終残高 = 初期残高 | 中 |
| RESULT-004 | CSV出力ボタン活性化 | ①トレード実施<br>②終了して結果ポップアップ表示 | ①CSV出力ボタンが活性化されている<br>②クリック可能 | 高 |
| RESULT-005 | CSV出力（トレードあり） | ①結果ポップアップでCSV出力をクリック | ①CSVファイルがダウンロードされる<br>②trade_id, side, lot_size, entry_price, exit_price, realized_pnl, realized_pnl_pips, opened_at, closed_atが記録されている | 高 |
| RESULT-006 | CSV出力（トレードなし） | ①トレードせず終了<br>②CSV出力をクリック | ①CSVファイルがダウンロードされる<br>②ヘッダー行のみ | 中 |

---

### 2.7 データ管理テスト

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| DATA-001 | CSV読込確認 | ①backend/data/フォルダ確認<br>②CSVファイル（日足・1時間足・10分足）が存在 | 3種類のCSVファイルが存在する | 高 |
| DATA-002 | データ日付範囲取得 | GET /api/v1/market-data/date-range | start_date, end_date, timeframesごとの範囲が返される | 中 |
| DATA-003 | ローソク足データ取得 | GET /api/v1/market-data/candles?timeframe=H1 | 1時間足のローソク足データが返される | 高 |

---

### 2.8 エッジケース・エラーハンドリングテスト

| テストID | テスト項目 | 手順 | 期待結果 | 優先度 |
|----------|------------|------|----------|--------|
| EDGE-001 | 未開始状態で注文 | ①シミュレーション未開始<br>②買いボタンをクリック | エラーメッセージが表示される | 中 |
| EDGE-002 | 停止状態で注文 | ①シミュレーション終了済<br>②買いボタンをクリック | エラーメッセージが表示される | 中 |
| EDGE-003 | 一時停止中に注文 | ①シミュレーション一時停止<br>②買いボタンをクリック | ①注文が約定される（仕様により動作確認）<br>または<br>②エラーメッセージ表示 | 低 |
| EDGE-004 | データ範囲外の日時指定 | データ範囲外の開始日時を指定 | エラーメッセージが表示される | 中 |
| EDGE-005 | ブラウザリロード | ①シミュレーション実行中<br>②ブラウザをリロード | ①シミュレーションがリセットされる<br>②初期画面に戻る | 低 |
| EDGE-006 | 長時間実行 | 速度10xで1時間以上実行 | ①メモリリークがない<br>②チャートが正常に動作し続ける | 中 |

---

## 3. テスト実施手順

### 3.1 事前準備
1. Docker Desktopを起動
2. プロジェクトルートで `docker-compose up -d` を実行
3. ブラウザで http://localhost:3000 を開く
4. 必要に応じてデベロッパーツールを開く（F12）

### 3.2 テスト実施
1. 上記テストケース一覧に従い、テストID順に実施
2. 各テストの結果を「テスト結果記録シート」に記録
3. 不具合発見時は以下を記録：
   - 再現手順
   - 期待結果
   - 実際の結果
   - スクリーンショット
   - コンソールログ

### 3.3 テスト完了条件
- 全ての「優先度: 高」テストケースがPASS
- 80%以上の「優先度: 中」テストケースがPASS
- クリティカルな不具合が0件

---

## 4. テスト結果記録フォーマット

### 4.1 テストサマリー
| 項目 | 件数 |
|------|------|
| 総テストケース数 | XX |
| 実施済テストケース数 | XX |
| PASS | XX |
| FAIL | XX |
| 未実施 | XX |

### 4.2 不具合一覧
| 不具合ID | テストID | 不具合内容 | 重要度 | 状態 |
|----------|----------|------------|--------|------|
| BUG-001 | XXX-XXX | XXXX | 高/中/低 | 未修正/修正中/修正済 |

---

## 5. テスト環境情報

### 5.1 ソフトウェアバージョン
- Docker:
- Docker Compose:
- Chrome:
- Node.js:
- Python:

### 5.2 テストデータ
- 日足データ: YYYY-MM-DD ～ YYYY-MM-DD
- 1時間足データ: YYYY-MM-DD ～ YYYY-MM-DD
- 10分足データ: YYYY-MM-DD ～ YYYY-MM-DD

---

## 6. 備考

### 6.1 既知の制約事項
- 実際の取引所との接続は行わない
- リアルタイムデータ配信は行わない
- 個人利用のため認証機能なし

### 6.2 テスト実施上の注意点
- 速度10xでのテストは特に、全てのチャートが正常に更新されることを確認
- 日足の24:00更新は必ず確認すること
- 一時停止時の即時停止を確認すること
- シミュレーション終了時の結果表示とCSV出力を必ず確認すること
