# 画面設計書

## 1. 画面一覧

| 画面ID | 画面名 | 説明 | 対応機能ID |
|--------|--------|------|------------|
| SCR-001 | メイン画面（トレードシミュレーター） | チャート表示・トレード操作の統合画面 | F-001〜F-007, F-110 |
| SCR-002 | シミュレーション設定モーダル | シミュレーション開始前の設定 | F-006, F-108 |
| SCR-003 | シミュレーション結果モーダル | シミュレーション終了時の結果表示 | F-109 |
| SCR-004 | データ管理画面 | 為替データのインポート・管理 | F-008, F-111 |

---

## 2. 画面遷移図

```
                    +-------------------+
                    |   アプリ起動      |
                    +-------------------+
                            |
                            v
                    +-------------------+
                    |  SCR-001          |
                    |  メイン画面       |<-----------------+
                    +-------------------+                  |
                       |    |    |                         |
          +------------+    |    +------------+            |
          |                 |                 |            |
          v                 v                 v            |
    +-----------+    +-----------+    +-----------+        |
    | SCR-002   |    | SCR-003   |    | SCR-004   |        |
    | 設定      |    | 結果      |    | データ    |        |
    | モーダル  |    | モーダル  |    | 管理      |        |
    +-----------+    +-----------+    +-----------+        |
          |                 |                 |            |
          +-----------------+-----------------+------------+
```

---

## 3. 画面詳細設計

### 3.1 SCR-001: メイン画面（トレードシミュレーター）

#### 3.1.1 画面レイアウト

**対応解像度**: 13インチ以上（1366×768〜）

```
+-------------------------------------------------------------------------------------------+
| FX Trade Simulator          2024/01/15 10:30      [データ管理] [設定] [終了]              |
+-------------------------------------------------------------------------------------------+
| +---------------------------+ +---------------------------+ +---------------------------+ |
| |        日足 (D1)          | |      1時間足 (H1)         | |      10分足 (M10)         | |
| |                           | |                           | |                           | |
| | [ローソク足チャート]      | | [ローソク足チャート]      | | [ローソク足チャート]      | |
| |                           | |                           | |                           | |
| |                           | |                           | |                           | |
| |                           | |                           | |                           | |
| +---------------------------+ +---------------------------+ +---------------------------+ |
+-------------------------------------------------------------------------------------------+
| [|<] [<] [ ▶ ] [>] [>|]  速度:[1x▼]  |  価格: 145.650  |  Lot:[0.1▼] [買い] [売り]      |
+-------------------------------------------------------------------------------------------+
| ポジション                                                                    [全決済]   |
| +----------+------+--------+--------+----------+-------+                                 |
| | 方向     | Lot  | Entry  | 現在   | 損益     | 操作  |  口座情報                       |
| +----------+------+--------+--------+----------+-------+  残高: ¥1,000,000               |
| | 買       | 0.10 | 145.50 | 145.65 | +¥1,500  | [決済]|  有効証拠金: ¥1,002,250         |
| | 売       | 0.05 | 145.80 | 145.65 | +¥750    | [決済]|  含み損益: +¥2,250              |
| +----------+------+--------+--------+----------+-------+  確定損益: ¥0                   |
+-------------------------------------------------------------------------------------------+
```

**レイアウト構成（縦方向）**
| エリア | 高さ目安 | 説明 |
|--------|----------|------|
| ヘッダー | 40px | タイトル、時刻、ボタン |
| チャートエリア | 約450px | 3チャート横並び（均等幅） |
| コントロールバー | 50px | 再生コントロール + 注文パネル（1行に統合） |
| ポジション・口座 | 約180px | ポジション一覧（左）+ 口座情報（右） |

**レイアウト構成（横方向）**
| エリア | 幅比率 | 説明 |
|--------|--------|------|
| 日足チャート | 33% | 左 |
| 1時間足チャート | 33% | 中央 |
| 10分足チャート | 33% | 右 |

#### 3.1.2 画面要素詳細

**ヘッダー部**
| 要素 | タイプ | 説明 |
|------|--------|------|
| タイトル | テキスト | アプリ名「FX Trade Simulator」 |
| データ管理ボタン | ボタン | SCR-004へ遷移 |
| 設定ボタン | ボタン | SCR-002モーダルを開く |
| 終了ボタン | ボタン | シミュレーションを終了（SCR-003表示） |

**チャートエリア（3つ）**
| 要素 | タイプ | 説明 |
|------|--------|------|
| 日足チャート | ローソク足チャート | 日足のOHLCを表示 |
| 1時間足チャート | ローソク足チャート | 1時間足のOHLCを表示 |
| 10分足チャート | ローソク足チャート | 10分足のOHLCを表示 |

**チャート共通仕様**
- 各チャートの右端（最新）の時刻は同期する
- マウスホイールで時間軸のズーム
- ドラッグで時間軸のスクロール
- ローソク足にマウスオーバーでOHLCV詳細表示

**チャート更新ロジック（タイムフレーム境界チェック）**
- 各タイムフレームは境界を跨いだ時のみ更新される（過剰な更新を防止）
  - **M10（10分足）**: 10分単位の境界チェック（例: 10:00, 10:10, 10:20...）
  - **H1（1時間足）**: 時刻の境界チェック（年・月・日・時のいずれかが変化）
  - **D1（日足）**: 日付の境界チェック（年・月・日のいずれかが変化、24:00で更新）
- これにより、高速再生（5x, 10x）時でもチャートが点滅せずスムーズに更新される

**トレードパネル**
| 要素 | タイプ | 説明 |
|------|--------|------|
| 現在価格 | テキスト | 現在のシミュレーション価格 |
| シミュレーション時刻 | テキスト | 現在のシミュレーション内時刻 |
| ロットサイズ | ドロップダウン | 0.01〜10.0（0.01刻み） |
| 買いボタン | ボタン | 成行買い注文を発注 |
| 売りボタン | ボタン | 成行売り注文を発注 |

**シミュレーションコントロール**
| 要素 | タイプ | 説明 |
|------|--------|------|
| 現在時刻表示 | テキスト | シミュレーション内の現在日時 |
| 最初に戻るボタン | ボタン | シミュレーション開始時刻に戻る |
| 前に戻るボタン | ボタン | 1ステップ（10分）戻る |
| 再生/一時停止ボタン | ボタン | シミュレーションの再生/一時停止切替 |
| 次に進むボタン | ボタン | 1ステップ（10分）進む |
| 最後に進むボタン | ボタン | データの最終時刻まで進む |
| 速度表示 | ドロップダウン | 再生速度（0.5x, 1x, 2x, 5x, 10x） |

**ポジション一覧**
| カラム | 説明 |
|--------|------|
| 方向 | 買/売 |
| ロット | ロットサイズ |
| エントリー価格 | 購入時の価格 |
| 現在価格 | 現在のシミュレーション価格 |
| 損益(円) | 含み損益（円表示） |
| 損益(pips) | 含み損益（pips表示） |
| 操作 | 決済ボタン |

**口座情報**
| 項目 | 説明 |
|------|------|
| 残高 | 現在の口座残高 |
| 有効証拠金 | 残高 + 含み損益 |
| 含み損益 | 保有ポジションの未実現損益合計 |
| 確定損益 | 決済済みトレードの損益合計 |

#### 3.1.3 画面アクション

| アクション | トリガー | 処理 |
|------------|----------|------|
| 買い注文発注 | 買いボタンクリック | POST `/api/v1/orders` |
| 売り注文発注 | 売りボタンクリック | POST `/api/v1/orders` |
| ポジション決済 | 決済ボタンクリック | POST `/api/v1/positions/{id}/close` |
| 全ポジション決済 | 全決済ボタンクリック | 全ポジションを順次決済 |
| シミュレーション再生 | 再生ボタンクリック | POST `/api/v1/simulation/resume` |
| シミュレーション一時停止 | 一時停止ボタンクリック | POST `/api/v1/simulation/pause` → タイマー停止（即座に反映） |
| 速度変更 | ドロップダウン選択 | PUT `/api/v1/simulation/speed` |
| シミュレーション終了 | 終了ボタンクリック | POST `/api/v1/simulation/stop` → SCR-003表示 |

**一時停止の即時反応実装**
- シミュレーション状態（running/paused）をRefで管理
- タイマーコールバック内で毎回状態をチェックし、paused状態の場合は処理を中断
- これにより、高速再生（5x, 10x）時でも一時停止ボタンを押した瞬間にチャート更新が停止する
- setIntervalのクリアだけでは既にスケジュールされたコールバックが実行されるため、この実装が必須

---

### 3.2 SCR-002: シミュレーション設定モーダル

#### 3.2.1 画面レイアウト

```
+------------------------------------------+
|  シミュレーション設定              [×]   |
+------------------------------------------+
|                                          |
|  開始日時                                |
|  +------------------------------------+  |
|  | 2024/01/15  09:00                  |  |
|  +------------------------------------+  |
|                                          |
|  初期資金                                |
|  +------------------------------------+  |
|  | ¥ 1,000,000                        |  |
|  +------------------------------------+  |
|                                          |
|  再生速度                                |
|  +------------------------------------+  |
|  | 1x                              ▼  |  |
|  +------------------------------------+  |
|                                          |
|  +------------------+ +----------------+ |
|  |    キャンセル    | |  開始する      | |
|  +------------------+ +----------------+ |
|                                          |
+------------------------------------------+
```

#### 3.2.2 画面要素詳細

| 要素 | タイプ | 説明 | バリデーション |
|------|--------|------|----------------|
| 開始日時 | 日時ピッカー | シミュレーション開始日時 | データ存在範囲内 |
| 初期資金 | 数値入力 | 初期口座残高 | 10,000〜100,000,000 |
| 再生速度 | ドロップダウン | 初期再生速度 | 0.5x, 1x, 2x, 5x, 10x |
| キャンセルボタン | ボタン | モーダルを閉じる | - |
| 開始するボタン | ボタン | シミュレーションを開始 | - |

#### 3.2.3 画面アクション

| アクション | トリガー | 処理 |
|------------|----------|------|
| シミュレーション開始 | 開始するボタンクリック | POST `/api/v1/simulation/start` |
| モーダルを閉じる | キャンセルボタン or ×ボタン | モーダルを閉じる |

---

### 3.3 SCR-003: シミュレーション結果モーダル

#### 3.3.1 画面レイアウト

```
+------------------------------------------+
|  シミュレーション結果              [×]   |
+------------------------------------------+
|                                          |
|  期間: 2024/01/15 09:00 〜 2024/01/20 17:00 |
|                                          |
|  +------------------------------------+  |
|  | 最終残高                           |  |
|  | ¥ 1,025,000                        |  |
|  +------------------------------------+  |
|                                          |
|  +------------------------------------+  |
|  | 損益                               |  |
|  | +¥ 25,000 (+2.5%)                  |  |
|  +------------------------------------+  |
|                                          |
|  +------------------------------------+  |
|  | トレード回数                       |  |
|  | 15 回                              |  |
|  +------------------------------------+  |
|                                          |
|  +------------------------------------+  |
|  | 勝敗                               |  |
|  | 10勝 5敗 (勝率: 66.7%)             |  |
|  +------------------------------------+  |
|                                          |
|  +------------------+ +----------------+ |
|  |  CSV出力         | |  閉じる        | |
|  +------------------+ +----------------+ |
|                                          |
+------------------------------------------+
```

#### 3.3.2 画面要素詳細

| 要素 | タイプ | 説明 |
|------|--------|------|
| 期間 | テキスト | シミュレーション期間 |
| 最終残高 | テキスト | シミュレーション終了時の残高 |
| 損益 | テキスト | 初期資金からの損益額とパーセンテージ |
| トレード回数 | テキスト | 決済済みトレードの総数 |
| 勝敗 | テキスト | 勝ち/負けの回数と勝率 |
| CSV出力ボタン | ボタン | トレード履歴をCSVダウンロード |
| 閉じるボタン | ボタン | モーダルを閉じる |

#### 3.3.3 画面アクション

| アクション | トリガー | 処理 |
|------------|----------|------|
| CSV出力 | CSV出力ボタンクリック | GET `/api/v1/trades/export` → ダウンロード |
| モーダルを閉じる | 閉じるボタン or ×ボタン | モーダルを閉じて新規シミュレーション待機状態へ |

---

### 3.4 SCR-004: データ管理画面

#### 3.4.1 画面レイアウト

```
+-----------------------------------------------------------------------------------+
|  FX Trade Simulator - データ管理                                      [← 戻る]   |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|  ローカルデータ状況                                                               |
|  +-------------------------------------------------------------------------------+|
|  | 時間足 | データ期間                    | レコード数 | 最終更新              ||
|  +--------+-------------------------------+------------+-----------------------+|
|  | 日足   | 2020/01/01 〜 2024/12/31      | 1,305      | 2024/01/10 15:30      ||
|  | 1時間足| 2022/01/01 〜 2024/12/31      | 26,304     | 2024/01/10 15:30      ||
|  | 10分足 | 2023/01/01 〜 2024/12/31      | 105,120    | 2024/01/10 15:30      ||
|  +-------------------------------------------------------------------------------+|
|                                                                                   |
|  外部データインポート                                                             |
|  +-------------------------------------------------------------------------------+|
|  | データソース: [Yahoo Finance ▼]                                              ||
|  | 通貨ペア: USDJPY                                                              ||
|  | 時間足: [1時間足 ▼]                                                           ||
|  | 期間: [2024/01/01] 〜 [2024/12/31]                                            ||
|  |                                                                               ||
|  | [インポート実行]                                                              ||
|  +-------------------------------------------------------------------------------+|
|                                                                                   |
|  CSVファイルアップロード                                                          |
|  +-------------------------------------------------------------------------------+|
|  | 時間足: [日足 ▼]                                                              ||
|  | ファイル: [ファイルを選択]                                                    ||
|  |                                                                               ||
|  | [アップロード]                                                                ||
|  +-------------------------------------------------------------------------------+|
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

#### 3.4.2 画面要素詳細

**ローカルデータ状況**
| カラム | 説明 |
|--------|------|
| 時間足 | D1, H1, M10 |
| データ期間 | データの開始日〜終了日 |
| レコード数 | 保存されているローソク足の数 |
| 最終更新 | 最後にデータが更新された日時 |

**外部データインポート**
| 要素 | タイプ | 説明 |
|------|--------|------|
| データソース | ドロップダウン | Yahoo Finance等 |
| 通貨ペア | テキスト（固定） | USDJPY |
| 時間足 | ドロップダウン | 日足, 1時間足, 10分足 |
| 期間 | 日付ピッカー×2 | 開始日〜終了日 |
| インポート実行ボタン | ボタン | 外部からデータ取得 |

**CSVファイルアップロード**
| 要素 | タイプ | 説明 |
|------|--------|------|
| 時間足 | ドロップダウン | 日足, 1時間足, 10分足 |
| ファイル | ファイル選択 | CSVファイル |
| アップロードボタン | ボタン | CSVをインポート |

#### 3.4.3 画面アクション

| アクション | トリガー | 処理 |
|------------|----------|------|
| 外部データインポート | インポート実行ボタンクリック | POST `/api/v1/market-data/import` |
| CSVアップロード | アップロードボタンクリック | ファイルアップロード処理 |
| メイン画面に戻る | 戻るボタンクリック | SCR-001へ遷移 |

---

## 4. レスポンシブ対応

本アプリケーションは13インチ以上のノートPC・デスクトップブラウザでの利用を前提とする。

**最小推奨解像度**: 1366×768（13インチノートPC相当）

**レイアウト調整**
| 解像度 | チャートレイアウト | 備考 |
|--------|-------------------|------|
| 1920×1080以上 | 3チャート横並び（ゆとりあり） | フルHD以上 |
| 1366×768〜1920×1080 | 3チャート横並び（コンパクト） | 13〜15インチノートPC |
| 1366×768未満 | 非対応（警告表示） | タブレット・スマホ非対応 |

**各解像度での表示仕様**
| 解像度 | チャート高さ | ポジション表示行数 |
|--------|-------------|-------------------|
| 1920×1080 | 500px | 最大10行 |
| 1600×900 | 420px | 最大6行 |
| 1366×768 | 350px | 最大4行（スクロール） |

---

## 5. カラーテーマ

| 要素 | カラーコード | 説明 |
|------|--------------|------|
| 背景色 | #1a1a2e | ダークブルー |
| カード背景 | #16213e | ネイビー |
| テキスト（通常） | #e6e6e6 | ライトグレー |
| テキスト（強調） | #ffffff | 白 |
| 買い/上昇 | #26a69a | グリーン |
| 売り/下落 | #ef5350 | レッド |
| ボタン（プライマリ） | #4fc3f7 | ライトブルー |
| ボタン（セカンダリ） | #78909c | グレー |
| ボーダー | #2d4263 | ダークブルー |

---

## 6. 使用ライブラリ（フロントエンド）

| ライブラリ | 用途 |
|------------|------|
| React | UIフレームワーク |
| TypeScript | 型安全な開発 |
| Lightweight Charts (TradingView) | ローソク足チャート描画 |
| Tailwind CSS | スタイリング |
| React Query | API通信・キャッシュ |
| Zustand | 状態管理 |
| date-fns | 日時処理 |
