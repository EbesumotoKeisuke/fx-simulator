# 結合テスト実施ガイド

## テスト実施状況サマリー

### APIテストで確認済み (2026-01-27)

以下のテストケースはAPIテストにより確認済みです：

#### 環境確認テスト
- ✅ ENV-003: バックエンド接続 - **PASS** (HTTP 200)

#### データ管理テスト
- ✅ DATA-002: データ日付範囲取得 - **PASS**
  - D1: 2020-10-06 ～ 2026-01-23 (1048件)
  - H1: 2023-05-12 ～ 2026-01-24 (15853件)
  - M10: 2024-12-22 ～ 2026-01-23 (40090件)
- ✅ DATA-003: ローソク足データ取得 - **PASS** (H1, M10, D1全て正常)

#### シミュレーション基本機能テスト
- ✅ SIM-002: 開始日時指定 - **PASS**
  - simulation_id生成、status=running、残高設定を確認
- ✅ GET /simulation/status - **PASS**
- ✅ SIM-011: シミュレーション終了 - **PASS**

#### 口座情報テスト
- ✅ GET /account - **PASS**
  - balance, equity, unrealized_pnl, realized_pnl, initial_balance確認

#### トレード機能テスト
- ✅ TRADE-001: 買い注文（成行） - **PASS**
  - order_id, position_id, entry_price, executed_at確認
- ✅ TRADE-002: 売り注文（成行） - **PASS**
- ✅ TRADE-007: ポジション表示 - **PASS**
  - side, lot_size, entry_price, current_price, unrealized_pnl確認
- ✅ TRADE-011: 利益確定決済 - **PASS**
  - trade_id, realized_pnl, closed_at確認

#### シミュレーション終了・結果表示テスト
- ✅ RESULT-001: 結果データ取得 - **PASS**
  - final_balance, total_trades, profit_loss確認
- ✅ RESULT-002: 保有ポジション自動決済 - **PASS**
  - 2件の保有ポジションが自動決済されたことを確認
- ✅ GET /trades (終了後) - **PASS**
  - 終了後もトレード履歴が取得可能
- ✅ GET /account (終了後) - **PASS**
  - 終了後も口座情報が取得可能

#### エッジケース・エラーハンドリングテスト
- ✅ TRADE-005: 無効なロットサイズ(0) - **PASS**
  - エラー: "Lot size must be between 0.01 and 100.0"
- ✅ TRADE-005: 無効なロットサイズ(負数) - **PASS**
  - エラー: "Lot size must be between 0.01 and 100.0"

---

## UI操作テスト実施ガイド

以下のテストケースは **UIでの手動操作** が必要です。

### 事前準備

1. Dockerを起動
2. プロジェクトルートで `docker-compose up -d`
3. ブラウザで http://localhost:3000 を開く
4. 開発者ツール（F12）を開いてコンソールエラーを確認できる状態にする

---

### テストセクション1: 環境確認とUI初期表示

#### ENV-001: Docker起動確認
```bash
docker-compose ps
```
**期待結果**: frontend, backend, dbの3コンテナが全てUp状態

#### ENV-002: フロントエンド接続
1. ブラウザで http://localhost:3000 にアクセス
**期待結果**: メインページが表示される

#### ENV-004: データベース接続
1. バックエンドのログを確認
```bash
docker-compose logs backend | grep -i error
```
**期待結果**: DB接続エラーがない

#### SIM-001: 初期表示
1. http://localhost:3000 を開く
**期待結果**:
- [ ] 開始日時入力フィールド表示
- [ ] 初期資金入力フィールド表示
- [ ] 速度選択（1x, 5x, 10x）表示
- [ ] 開始ボタン表示

---

### テストセクション2: シミュレーション基本機能（速度1x）

#### SIM-002 & SIM-003: 開始日時指定と速度1x開始
1. 開始日時: `2024-12-23 00:00` を入力
2. 初期資金: `1000000` を入力
3. 速度: `1x` を選択
4. 開始ボタンをクリック

**期待結果**:
- [ ] シミュレーションが開始される
- [ ] 日足・1時間足・10分足チャートが表示される
- [ ] 現在時刻表示が `2024-12-23 00:00` になる
- [ ] 残高が `1,000,000` と表示される
- [ ] チャートが約1秒ごとに更新される
- [ ] 現在時刻が1秒ごとに10分進む

#### CHART-001, CHART-002, CHART-003: マルチタイムフレーム表示
**期待結果**:
- [ ] 日足チャート表示（ラベル「日足」あり）
- [ ] 1時間足チャート表示（ラベル「1時間足」あり）
- [ ] 10分足チャート表示（ラベル「10分足」あり）
- [ ] 始値・高値・安値・終値が正しく表示
- [ ] 陽線は緑、陰線は赤で表示

#### SIM-006: 一時停止（1x）
1. シミュレーション実行中に一時停止ボタンをクリック

**期待結果**:
- [ ] チャート更新が停止する
- [ ] 現在時刻が止まる
- [ ] 再開ボタンが表示される

#### SIM-009: 再開
1. 再開ボタンをクリック

**期待結果**:
- [ ] チャート更新が再開される
- [ ] 現在時刻が進み始める

---

### テストセクション3: 高速シミュレーション（速度5x, 10x）

#### SIM-004: 速度5x開始
1. 新しいシミュレーションを開始
2. 速度: `5x` を選択
3. 開始ボタンをクリック

**期待結果**:
- [ ] チャートが約0.2秒ごとに更新される
- [ ] 現在時刻が0.2秒ごとに10分進む

#### SIM-007: 一時停止（5x）⭐重要テスト
1. 速度5xで実行中
2. 一時停止ボタンをクリック

**期待結果**:
- [ ] **即座に**チャート更新が停止する
- [ ] 10分足チャートも**即座に**停止する
- [ ] **数秒間更新が続かない**（重要：以前のバグ修正確認）

#### SIM-005: 速度10x開始
1. 新しいシミュレーションを開始
2. 速度: `10x` を選択
3. 開始ボタンをクリック

**期待結果**:
- [ ] チャートが約0.1秒ごとに更新される
- [ ] 現在時刻が0.1秒ごとに10分進む
- [ ] **チャートが正常に更新される（点滅なし）**（重要：以前のバグ修正確認）

#### SIM-008: 一時停止（10x）
1. 速度10xで実行中
2. 一時停止ボタンをクリック

**期待結果**:
- [ ] 即座にチャート更新が停止する
- [ ] 全てのチャートが即座に停止する

---

### テストセクション4: チャート更新タイミング（10x速度）⭐重要テスト

#### CHART-004: 10分足更新
1. 速度10xで実行
2. 10分足チャートを観察

**期待結果**:
- [ ] 10分ごとに新しいローソク足が追加される
- [ ] 点滅しない

#### CHART-005: 1時間足更新
1. 速度10xで1時間以上実行
2. 1時間足チャートを観察

**期待結果**:
- [ ] 1時間足チャートが新しいローソク足を追加する
- [ ] **60分経過時に正確に更新される**
- [ ] 点滅しない

#### CHART-006, CHART-007: 日足更新（24:00）⭐重要テスト
1. 速度10xで24:00（日付変更）をまたぐように実行
2. 日足チャートを観察
3. 複数日実行して観察

**期待結果**:
- [ ] **24:00（日付変更）時に日足チャートが新しいローソク足を追加する**（重要：以前のバグ修正確認）
- [ ] 点滅や重複がない
- [ ] 毎日24:00に日足が更新される
- [ ] 更新タイミングが一定

#### CHART-008, CHART-009, CHART-010: チャート更新パフォーマンス
1. 速度10xで5分以上実行

**期待結果**:
- [ ] 10分足チャートが点滅せず、スムーズに更新される
- [ ] 1時間足チャートが点滅せず、スムーズに更新される
- [ ] 日足チャートが点滅せず、スムーズに更新される

---

### テストセクション5: トレード機能（UI操作）

#### TRADE-001, TRADE-007: 買い注文とポジション表示
1. シミュレーション実行中
2. ロットサイズ: `0.1` を入力
3. 「買い」ボタンをクリック
4. ポジション一覧を確認

**期待結果**:
- [ ] 注文が約定される
- [ ] ポジション一覧に1件表示される
- [ ] side: buy
- [ ] lot_size: 0.1
- [ ] entry_price: （数値表示）
- [ ] opened_at: （時刻表示）

#### TRADE-002: 売り注文
1. ロットサイズ: `0.1` を入力
2. 「売り」ボタンをクリック

**期待結果**:
- [ ] 注文が約定される
- [ ] ポジション一覧に追加表示される

#### TRADE-008, TRADE-009: 含み損益表示
1. 買いポジションを保有
2. シミュレーションを進めて価格変動を観察

**期待結果**:
- [ ] 価格上昇時: unrealized_pnl（含み損益）がプラス表示
- [ ] 価格下落時: unrealized_pnl（含み損益）がマイナス表示（赤字）
- [ ] current_price（現在価格）が更新される

#### TRADE-010: 複数ポジション
1. 買いポジション1件と売りポジション1件を保有

**期待結果**:
- [ ] 両方のポジションが一覧に表示される
- [ ] 合計含み損益が正しく計算される

#### TRADE-011, TRADE-012: ポジション決済
1. 含み益のあるポジションの決済ボタンをクリック
2. 含み損のあるポジションの決済ボタンをクリック

**期待結果**:
- [ ] 利益確定: ポジション決済、realized_pnlプラス、残高増加
- [ ] 損切り: ポジション決済、realized_pnlマイナス、残高減少
- [ ] トレード履歴に記録される

#### TRADE-003, TRADE-004: 複数ロット・最小ロット注文
1. ロットサイズ: `1.0` で注文
2. ロットサイズ: `0.01` で注文

**期待結果**:
- [ ] 1.0ロットのポジションが建つ
- [ ] 0.01ロットのポジションが建つ
- [ ] 必要証拠金が正しく計算される

#### TRADE-013: 複数決済
1. 3件のポジションを建てる
2. 1件ずつ決済

**期待結果**:
- [ ] 各ポジションが正しく決済される
- [ ] 残高が正しく更新される
- [ ] トレード履歴が3件記録される

---

### テストセクション6: 資金・損益管理（UI確認）

#### ACCOUNT-001: 初期資金設定
1. 初期資金1,000,000円で開始
2. 口座情報パネルを確認

**期待結果**:
- [ ] balance（残高）が1,000,000円と表示される

#### ACCOUNT-002, ACCOUNT-003: 残高更新
1. +10,000円の利益で決済
2. -5,000円の損失で決済

**期待結果**:
- [ ] 利益時: balanceが1,010,000円になる
- [ ] 損失時: balanceが995,000円になる（1,000,000 - 5,000）

#### ACCOUNT-004: 証拠金計算
1. 0.1ロットの買いポジション保有
2. 口座情報確認

**期待結果**:
- [ ] margin_used（使用証拠金）が表示される
- [ ] margin_available（余剰証拠金）が計算される

#### ACCOUNT-005: 評価額計算
1. ポジション保有（含み益あり）
2. 口座情報確認

**期待結果**:
- [ ] equity（評価額）= balance + unrealized_pnl

#### ACCOUNT-006: トレード履歴記録
1. 複数回トレード
2. トレード履歴を確認

**期待結果**:
- [ ] 全てのトレードが記録されている
- [ ] trade_id, side, lot_size, entry_price, exit_price, realized_pnl, opened_at, closed_atが記録されている

---

### テストセクション7: シミュレーション終了・結果表示（UI確認）⭐重要テスト

#### RESULT-001, RESULT-002, RESULT-004: 結果ポップアップ表示
1. トレードを数回実施
2. ポジションを2件保有した状態で終了ボタンをクリック
3. 確認ダイアログでOK

**期待結果**:
- [ ] シミュレーションが停止する
- [ ] **結果ポップアップが表示される**（重要：以前のバグ修正確認）
- [ ] 最終残高が表示される
- [ ] 総トレード数が表示される（保有ポジション自動決済分を含む）
- [ ] 確定損益が表示される
- [ ] **CSV出力ボタンが活性化されている**（重要：以前のバグ修正確認）

#### RESULT-005: CSV出力（トレードあり）
1. 結果ポップアップでCSV出力ボタンをクリック

**期待結果**:
- [ ] CSVファイルがダウンロードされる
- [ ] trade_id, side, lot_size, entry_price, exit_price, realized_pnl, realized_pnl_pips, opened_at, closed_atが記録されている
- [ ] 全てのトレード（自動決済分を含む）が記録されている

#### RESULT-003, RESULT-006: トレード0件の結果
1. トレードせずに終了ボタンをクリック

**期待結果**:
- [ ] 結果ポップアップが表示される
- [ ] 総トレード数: 0
- [ ] 最終残高 = 初期残高
- [ ] CSV出力ボタンをクリック
- [ ] CSVファイルがダウンロードされる（ヘッダー行のみ）

---

### テストセクション8: 速度変更（UI確認）

#### SIM-010: 速度変更
1. 速度1xで開始
2. 速度を5xに変更

**期待結果**:
- [ ] チャート更新速度が5xに変わる
- [ ] チャートが正常に表示される

---

### テストセクション9: エッジケース・エラーハンドリング

#### EDGE-001: 未開始状態で注文
1. シミュレーション未開始
2. 買いボタンをクリック

**期待結果**:
- [ ] エラーメッセージが表示される

#### EDGE-002: 停止状態で注文
1. シミュレーション終了済
2. 買いボタンをクリック

**期待結果**:
- [ ] エラーメッセージが表示される

#### EDGE-003: 一時停止中に注文
1. シミュレーション一時停止
2. 買いボタンをクリック

**期待結果**:
- [ ] 注文が約定される、または
- [ ] エラーメッセージが表示される
（※動作を確認して記録）

#### EDGE-004: データ範囲外の日時指定
1. データ範囲外の開始日時を指定（例: 2019-01-01）
2. 開始ボタンをクリック

**期待結果**:
- [ ] エラーメッセージが表示される

#### EDGE-005: ブラウザリロード
1. シミュレーション実行中
2. ブラウザをリロード（F5）

**期待結果**:
- [ ] シミュレーションがリセットされる
- [ ] 初期画面に戻る

#### EDGE-006: 長時間実行
1. 速度10xで1時間以上実行
2. ブラウザのメモリ使用量を確認
3. チャート動作を確認

**期待結果**:
- [ ] メモリリークがない
- [ ] チャートが正常に動作し続ける

#### TRADE-006: 残高不足
1. 初期資金10,000円で開始
2. ロットサイズ10.0で注文

**期待結果**:
- [ ] エラーメッセージが表示される
- [ ] 注文が約定されない

---

## テスト実施チェックリスト

### 優先度「高」のテスト（必須）
- [ ] ENV-001, ENV-002, ENV-003, ENV-004
- [ ] SIM-001, SIM-002, SIM-003, SIM-005 (特に10x速度)
- [ ] SIM-006, SIM-007, SIM-008, SIM-009, SIM-011
- [ ] CHART-001, CHART-003, CHART-004, CHART-005, CHART-006, CHART-007
- [ ] CHART-008, CHART-009, CHART-010 (パフォーマンステスト)
- [ ] TRADE-001, TRADE-002, TRADE-007, TRADE-011
- [ ] ACCOUNT-001, ACCOUNT-005, ACCOUNT-006
- [ ] RESULT-001, RESULT-002, RESULT-004, RESULT-005

### 優先度「中」のテスト
- [ ] SIM-010
- [ ] CHART-002
- [ ] TRADE-003, TRADE-004, TRADE-010, TRADE-013
- [ ] ACCOUNT-002, ACCOUNT-003, ACCOUNT-004
- [ ] RESULT-003, RESULT-006
- [ ] DATA-001, DATA-002, DATA-003
- [ ] EDGE-001, EDGE-002, EDGE-004, EDGE-006
- [ ] TRADE-005, TRADE-006

### 優先度「低」のテスト
- [ ] EDGE-003, EDGE-005

---

## テスト完了条件

- ✅ 全ての優先度「高」テストがPASS
- ✅ 80%以上の優先度「中」テストがPASS
- ✅ クリティカルな不具合が0件

---

## 不具合発見時の記録方法

不具合を発見した場合は、以下の情報を記録してください：

1. **テストID**: (例: SIM-005)
2. **再現手順**: 詳細なステップ
3. **期待結果**: あるべき動作
4. **実際の結果**: 実際に起きたこと
5. **スクリーンショット**: 可能であれば添付
6. **コンソールログ**: 開発者ツールのConsoleタブのエラー
7. **環境情報**: ブラウザ、OS、Docker version等

---

## テスト実施後のアクション

1. [integration-test-results.md](integration-test-results.md) にテスト結果を記録
2. 不具合があれば修正して再テスト
3. 全テスト完了後、テスト結果レポートを作成
